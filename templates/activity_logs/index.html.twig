{% extends 'base.html.twig' %}

{% block title %}Activity Logs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .page-title {
            margin-bottom: 30px;
            color: #2E1F1D;
            font-weight: 600;
        }
        
        .action-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .action-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .action-login { background-color: #d1e7dd; color: #0f5132; }
        .action-logout { background-color: #e2e3e5; color: #41464b; }
        .action-created { background-color: #d1ecf1; color: #0c5460; }
        .action-updated { background-color: #fff3cd; color: #856404; }
        .action-deleted { background-color: #f8d7da; color: #721c24; }
        .action-equipment { background-color: #e2d9f3; color: #4a235a; }
        .action-user { background-color: #d6d8db; color: #383d41; }
        .action-booking { background-color: #cfe2ff; color: #084298; }
        .action-payment { background-color: #d1e7dd; color: #0f5132; }
        
        /* DataTables customization */
        .dataTables_wrapper {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .dataTables_length select {
            border: 1px solid #D5BDAF;
            border-radius: 4px;
            padding: 5px;
        }
        
        .dataTables_filter input {
            border: 1px solid #D5BDAF;
            border-radius: 4px;
            padding: 5px 10px;
        }
        
        /* Position search bar in top right */
        .dataTables_filter {
            position: absolute;
            top: 20px;
            right: 20px;
            margin: 0;
        }
        
        .dataTables_filter > label {
            margin: 0;
            font-weight: normal;
        }
        
        .dataTables_filter input {
            width: 250px;
            margin-left: 10px;
        }
        
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table thead th {
            background-color: #F5F0EB;
            color: #2E1F1D;
            font-weight: 600;
            border-bottom: 2px solid #D5BDAF;
            padding: 15px 10px;
        }
        
        .table tbody td {
            padding: 12px 10px;
            border-top: 1px solid #E8DFD8;
            vertical-align: top;
        }
        
        .table tbody tr:hover {
            background-color: rgba(213, 189, 175, 0.1);
        }
        
        /* Adjust DataTables header layout */
        .dt-buttons {
            margin-bottom: 15px;
        }
        
        .dt-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        /* Filter section styling */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #F9F7F5;
            border-radius: 8px;
            border: 1px solid #E8DFD8;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-label {
            font-weight: 600;
            color: #2E1F1D;
            white-space: nowrap;
        }
        
        .btn-filter {
            border: 1px solid #dee2e6;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-filter:hover {
            transform: translateY(-1px);
        }
        
        .btn-filter.active {
            border-color: #2E1F1D;
            background-color: #2E1F1D;
            color: white;
        }
        
        /* Action filter colors */
        .btn-filter-all:hover {
            border-color: #2E1F1D;
            color: #2E1F1D;
        }
        
        .btn-filter-all.active {
            background-color: #2E1F1D;
            border-color: #2E1F1D;
            color: white;
        }
        
        .btn-filter-login:hover {
            border-color: #198754;
            color: #198754;
        }
        
        .btn-filter-login.active {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        
        .btn-filter-created:hover {
            border-color: #0dcaf0;
            color: #0dcaf0;
        }
        
        .btn-filter-created.active {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
            color: #000;
        }
        
        .btn-filter-updated:hover {
            border-color: #ffc107;
            color: #856404;
        }
        
        .btn-filter-updated.active {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        
        .btn-filter-deleted:hover {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .btn-filter-deleted.active {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* Custom filter controls */
        .user-filter, .action-filter, .date-filter {
            width: 180px;
        }
        
        /* Date range filter */
        .date-filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .date-input {
            width: 150px;
        }
        
        .date-separator {
            color: #666;
            font-weight: 500;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .dataTables_filter {
                position: static;
                margin-top: 10px;
                margin-bottom: 15px;
                width: 100%;
            }
            
            .dataTables_filter input {
                width: 100%;
                margin-left: 0;
            }
            
            .filter-section {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dataTables_wrapper {
                padding: 10px;
                overflow-x: auto;
            }
            
            .user-filter, .action-filter, .date-filter {
                width: 100%;
            }
            
            .date-input {
                width: 120px;
            }
        }
        
        .timestamp-cell {
            font-size: 0.85rem;
            color: #6c757d;
            white-space: nowrap;
        }
        
        .target-data-cell {
            max-width: 300px;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 0.9rem;
            color: #495057;
            line-height: 1.4;
        }
        
        .user-info {
            font-weight: 500;
            color: #2E1F1D;
        }
        
        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: #e8dfd8;
            color: #2E1F1D;
            margin-left: 5px;
        }
        
        /* Legend indicators */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="page-title">Activity Logs</h1>
        
        <div class="action-bar">
            <div class="d-flex gap-3">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #d1e7dd;"></span>
                    <small class="text-muted">Login/Create</small>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #fff3cd;"></span>
                    <small class="text-muted">Update</small>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #f8d7da;"></span>
                    <small class="text-muted">Delete</small>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #e2e3e5;"></span>
                    <small class="text-muted">Logout</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">
                    <i class="fas fa-filter-circle-xmark me-1"></i>Clear Filters
                </button>
            </div>
        </div>
        
        <!-- Filter section with custom filters -->
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">Action Type:</span>
                <button class="btn btn-filter btn-filter-all active" id="filterAll">All</button>
                <button class="btn btn-filter btn-filter-login" id="filterLogin">Login/Logout</button>
                <button class="btn btn-filter btn-filter-created" id="filterCreated">Create</button>
                <button class="btn btn-filter btn-filter-updated" id="filterUpdated">Update</button>
                <button class="btn btn-filter btn-filter-deleted" id="filterDeleted">Delete</button>
            </div>
            
            <!-- User Filter -->
            <div class="filter-group">
                <span class="filter-label">User:</span>
                <input type="text" class="form-control form-control-sm user-filter" id="userFilter" placeholder="Search user...">
            </div>
            
            <!-- Date Range Filter -->
            <div class="filter-group">
                <span class="filter-label">Date Range:</span>
                <div class="date-filter-group">
                    <input type="date" class="form-control form-control-sm date-input" id="startDate">
                    <span class="date-separator">to</span>
                    <input type="date" class="form-control form-control-sm date-input" id="endDate">
                </div>
            </div>
            
            <!-- Quick Date Filters -->
            <div class="filter-group">
                <span class="filter-label">Quick Date:</span>
                <button class="btn btn-outline-secondary btn-sm" id="todayBtn">Today</button>
                <button class="btn btn-outline-secondary btn-sm" id="weekBtn">This Week</button>
                <button class="btn btn-outline-secondary btn-sm" id="monthBtn">This Month</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="activityTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Action</th>
                        <th>Target Data</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                        <tr>
                            <td>{{ log.id }}</td>
                            <td data-search="{{ log.username ?? 'Anonymous' }}{% if log.userId %} {{ log.userId }}{% endif %}">
                                <span class="user-info">
                                    {{ log.username ?? 'Anonymous' }}
                                    {% if log.userId %}
                                        <br><small class="text-muted">ID: {{ log.userId }}</small>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if log.userRole %}
                                    <span class="role-badge" data-search="{{ log.userRole }}">{{ log.userRole }}</span>
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% set actionLower = log.action|lower %}
                                {% set actionClass = 'action-login' %}
                                {% set actionType = 'login' %}
                                
                                {% if 'logout' in actionLower %}
                                    {% set actionClass = 'action-logout' %}
                                    {% set actionType = 'logout' %}
                                {% elseif 'created' in actionLower or 'create' in actionLower %}
                                    {% set actionClass = 'action-created' %}
                                    {% set actionType = 'create' %}
                                {% elseif 'updated' in actionLower or 'update' in actionLower %}
                                    {% set actionClass = 'action-updated' %}
                                    {% set actionType = 'update' %}
                                {% elseif 'deleted' in actionLower or 'delete' in actionLower %}
                                    {% set actionClass = 'action-deleted' %}
                                    {% set actionType = 'delete' %}
                                {% elseif 'equipment' in actionLower %}
                                    {% set actionClass = 'action-equipment' %}
                                {% elseif 'user' in actionLower %}
                                    {% set actionClass = 'action-user' %}
                                {% elseif 'booking' in actionLower %}
                                    {% set actionClass = 'action-booking' %}
                                {% elseif 'payment' in actionLower %}
                                    {% set actionClass = 'action-payment' %}
                                {% endif %}
                                
                                <span class="action-badge {{ actionClass }}" data-action-type="{{ actionType }}">
                                    {{ log.action|replace({'_': ' '})|title }}
                                </span>
                            </td>
                            <td class="target-data-cell">{{ log.targetData ?? '—' }}</td>
                            <td class="timestamp-cell" data-order="{{ log.createdAt|date('U') }}">
                                {{ log.createdAt|date('Y-m-d H:i:s') }}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">No activity logs found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables Core JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- DataTables Extensions -->
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    
    <!-- PDF export support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize DataTable with search bar positioned on right
            var table = $('#activityTable').DataTable({
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="fas fa-copy"></i> Copy',
                        className: 'btn btn-outline-secondary',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-outline-success',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn btn-outline-danger',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        },
                        customize: function(doc) {
                            doc.content[1].table.widths = 
                                ['5%', '15%', '10%', '15%', '35%', '20%'];
                        }
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Print',
                        className: 'btn btn-outline-dark',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'colvis',
                        text: '<i class="fas fa-columns"></i> Columns',
                        className: 'btn btn-outline-info'
                    }
                ],
                language: {
                    search: "Search logs:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ logs",
                    infoEmpty: "Showing 0 to 0 of 0 logs",
                    infoFiltered: "(filtered from _MAX_ total logs)",
                    zeroRecords: "No matching logs found",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                order: [[0, 'desc']], // Sort by ID descending (newest first)
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                columnDefs: [
                    {
                        targets: 3, // Action column
                        render: function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Extract action type for sorting
                                var span = $('<div>').html(data).find('[data-action-type]');
                                if (span.length) {
                                    return span.data('action-type') || '';
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    {
                        targets: 5, // Timestamp column
                        type: 'date',
                        render: function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Use data-order attribute for sorting
                                var td = $('<div>').html(data).find('td');
                                if (td.length && td.data('order')) {
                                    return td.data('order');
                                }
                                // Extract timestamp from text
                                var dateMatch = data.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
                                return dateMatch ? new Date(dateMatch[1]).getTime() : 0;
                            }
                            return data;
                        }
                    }
                ]
            });
            
            // Custom filter functions for action types
            function filterByActionType(actionType) {
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        // Check action column (index 3)
                        var actionCell = table.cell(dataIndex, 3).node();
                        if (actionCell) {
                            var actionTypeAttr = $(actionCell).find('[data-action-type]').data('action-type');
                            return actionTypeAttr === actionType;
                        }
                        return false;
                    }
                );
                table.draw();
                $.fn.dataTable.ext.search.pop();
            }
            
            function filterLoginLogout() {
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        var actionCell = table.cell(dataIndex, 3).node();
                        if (actionCell) {
                            var actionType = $(actionCell).find('[data-action-type]').data('action-type');
                            return actionType === 'login' || actionType === 'logout';
                        }
                        return false;
                    }
                );
                table.draw();
                $.fn.dataTable.ext.search.pop();
            }
            
            function clearAllFilters() {
                table.search('').columns().search('').draw();
                $('#userFilter').val('');
                $('#startDate').val('');
                $('#endDate').val('');
                $('.btn-filter').removeClass('active');
                $('#filterAll').addClass('active');
            }
            
            // Action filter buttons
            $('#filterAll').click(function() {
                clearAllFilters();
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterLogin').click(function() {
                clearAllFilters();
                filterLoginLogout();
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterCreated').click(function() {
                clearAllFilters();
                filterByActionType('create');
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterUpdated').click(function() {
                clearAllFilters();
                filterByActionType('update');
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterDeleted').click(function() {
                clearAllFilters();
                filterByActionType('delete');
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            // Set initial active filter
            $('#filterAll').addClass('active');
            
            // Style the DataTables buttons
            $('.dt-buttons .btn').removeClass('btn-secondary').addClass('me-2 mb-2');
            
            // Add custom search input styling
            $('.dataTables_filter input').addClass('form-control form-control-sm').attr('placeholder', 'Search logs...');
            
            // Add custom length select styling
            $('.dataTables_length select').addClass('form-select form-select-sm');
            
            // User filter
            $('#userFilter').on('keyup', function() {
                var val = $(this).val();
                table.column(1).search(val).draw();
            });
            
            // Date range filter
            function filterByDateRange() {
                var startDate = $('#startDate').val();
                var endDate = $('#endDate').val();
                
                if (!startDate && !endDate) {
                    // If both are empty, clear the filter
                    $.fn.dataTable.ext.search.pop();
                    table.draw();
                    return;
                }
                
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        var dateCell = table.cell(dataIndex, 5).data();
                        // Extract date from cell (format: YYYY-MM-DD HH:MM:SS)
                        var dateMatch = dateCell.match(/(\d{4}-\d{2}-\d{2})/);
                        if (!dateMatch) return false;
                        
                        var cellDate = dateMatch[1];
                        
                        if (startDate && endDate) {
                            return cellDate >= startDate && cellDate <= endDate;
                        } else if (startDate) {
                            return cellDate >= startDate;
                        } else if (endDate) {
                            return cellDate <= endDate;
                        }
                        return true;
                    }
                );
                table.draw();
                $.fn.dataTable.ext.search.pop();
            }
            
            $('#startDate, #endDate').on('change', function() {
                filterByDateRange();
            });
            
            // Quick date filters
            $('#todayBtn').click(function() {
                var today = new Date().toISOString().split('T')[0];
                $('#startDate').val(today);
                $('#endDate').val(today);
                filterByDateRange();
            });
            
            $('#weekBtn').click(function() {
                var today = new Date();
                var startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                
                $('#startDate').val(startOfWeek.toISOString().split('T')[0]);
                $('#endDate').val(today.toISOString().split('T')[0]);
                filterByDateRange();
            });
            
            $('#monthBtn').click(function() {
                var today = new Date();
                var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                $('#startDate').val(startOfMonth.toISOString().split('T')[0]);
                $('#endDate').val(today.toISOString().split('T')[0]);
                filterByDateRange();
            });
            
            // Refresh button
            $('#refreshBtn').click(function() {
                location.reload();
            });
            
            // Clear filters button
            $('#clearFiltersBtn').click(function() {
                clearAllFilters();
            });
            
            // Auto-populate user filter dropdown from table data
            function populateUserFilter() {
                var users = [];
                table.column(1).data().each(function(value) {
                    // Extract username from the cell's data-search attribute
                    var cell = $('<div>').html(value).find('[data-search]');
                    if (cell.length && cell.data('search')) {
                        var userData = cell.data('search').split(' ');
                        if (userData[0] && users.indexOf(userData[0]) === -1) {
                            users.push(userData[0]);
                        }
                    }
                });
                
                if (users.length > 0) {
                    users.sort();
                    // Could create a dropdown here if needed
                }
            }
            
            // Call on initialization
            populateUserFilter();
        });
    </script>
{% endblock %}