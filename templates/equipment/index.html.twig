{% extends 'base.html.twig' %}

{% block title %}Equipment Dashboard{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .page-title {
            margin-bottom: 30px;
            color: #2E1F1D;
            font-weight: 600;
        }
        
        .action-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .btn-create {
            background-color: #2E1F1D;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn-create:hover {
            background-color: #D5BDAF;
            color: #2E1F1D;
        }
        
        .btn-show, .btn-edit {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
        }
        
        .btn-show {
            background-color: #8FA3B8;
            color: white;
            border: 1px solid #8FA3B8;
        }
        
        .btn-show:hover {
            background-color: #7a91a9;
            color: white;
        }
        
        .btn-edit {
            background-color: #D5BDAF;
            color: #2E1F1D;
            border: 1px solid #D5BDAF;
        }
        
        .btn-edit:hover {
            background-color: #c9ab9b;
            color: #2E1F1D;
        }
        
        .delete-form {
            display: inline-block;
        }
        
        .btn-icon {
            background: none;
            border: none;
            padding: 5px;
            color: #dc3545;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover:not(:disabled) {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .btn-icon:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .availability-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .availability-yes {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .availability-no {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .price-cell {
            font-weight: 600;
            color: #2E1F1D;
        }
        
        /* DataTables customization */
        .dataTables_wrapper {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .dataTables_length select {
            border: 1px solid #D5BDAF;
            border-radius: 4px;
            padding: 5px;
        }
        
        .dataTables_filter input {
            border: 1px solid #D5BDAF;
            border-radius: 4px;
            padding: 5px 10px;
        }
        
        /* NEW: Position search bar in top right */
        .dataTables_filter {
            position: absolute;
            top: 20px;
            right: 20px;
            margin: 0;
        }
        
        .dataTables_filter > label {
            margin: 0;
            font-weight: normal;
        }
        
        .dataTables_filter input {
            width: 250px;
            margin-left: 10px;
        }
        
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table thead th {
            background-color: #F5F0EB;
            color: #2E1F1D;
            font-weight: 600;
            border-bottom: 2px solid #D5BDAF;
            padding: 15px 10px;
        }
        
        .table tbody td {
            padding: 12px 10px;
            border-top: 1px solid #E8DFD8;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background-color: rgba(213, 189, 175, 0.1);
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        /* NEW: Adjust DataTables header layout */
        .dt-buttons {
            margin-bottom: 15px;
        }
        
        .dt-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        /* NEW: Filter section styling */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #F9F7F5;
            border-radius: 8px;
            border: 1px solid #E8DFD8;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-label {
            font-weight: 600;
            color: #2E1F1D;
            white-space: nowrap;
        }
        
        .btn-filter {
            border: 1px solid #dee2e6;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-filter:hover {
            transform: translateY(-1px);
        }
        
        .btn-filter.active {
            border-color: #2E1F1D;
            background-color: #2E1F1D;
            color: white;
        }
        
        /* Status filter colors */
        .btn-filter-all:hover {
            border-color: #2E1F1D;
            color: #2E1F1D;
        }
        
        .btn-filter-all.active {
            background-color: #2E1F1D;
            border-color: #2E1F1D;
            color: white;
        }
        
        .btn-filter-available:hover {
            border-color: #198754;
            color: #198754;
        }
        
        .btn-filter-available.active {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        
        .btn-filter-unavailable:hover {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .btn-filter-unavailable.active {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* Custom filter controls */
        .type-filter, .price-filter {
            width: 180px;
        }
        
        /* Price range filter */
        .price-filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .price-input {
            width: 100px;
        }
        
        .price-separator {
            color: #666;
            font-weight: 500;
        }
        
        /* Booking count badge */
        .booking-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .booking-badge.has-bookings {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .booking-badge.no-bookings {
            background-color: #e7e7e7;
            color: #666;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .dataTables_filter {
                position: static;
                margin-top: 10px;
                margin-bottom: 15px;
                width: 100%;
            }
            
            .dataTables_filter input {
                width: 100%;
                margin-left: 0;
            }
            
            .filter-section {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dataTables_wrapper {
                padding: 10px;
                overflow-x: auto;
            }
            
            .type-filter, .price-filter {
                width: 100%;
            }
            
            .price-input {
                width: 80px;
            }
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-available {
            background-color: #198754;
        }
        
        .status-unavailable {
            background-color: #dc3545;
        }
        
        /* Flash messages */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .alert {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="page-title">Equipment Dashboard</h1>
        
        <!-- Flash Messages Container -->
        <div class="alert-container">
            {% for message in app.flashes('error') %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            
            {% for message in app.flashes('success') %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
        
        <div class="action-bar">
            <a href="{{ path('app_equipment_new') }}" class="btn btn-create">
                <i class="fas fa-plus me-2"></i>Add New Equipment
            </a>
            
            <div class="d-flex gap-3">
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-available"></span>
                    <small class="text-muted">Available</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-unavailable"></span>
                    <small class="text-muted">Unavailable</small>
                </div>
            </div>
        </div>
        
        <!-- Filter section with custom filters -->
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">Availability:</span>
                <button class="btn btn-filter btn-filter-all active" id="filterAll">All</button>
                <button class="btn btn-filter btn-filter-available" id="filterAvailable">Available</button>
                <button class="btn btn-filter btn-filter-unavailable" id="filterUnavailable">Unavailable</button>
            </div>
            
            <!-- Equipment Type Filter -->
            <div class="filter-group">
                <span class="filter-label">Equipment Type:</span>
                <select class="form-select form-select-sm type-filter" id="typeFilter">
                    <option value="">All Types</option>
                    {% for equipmentType in equipmentTypes|default([]) %}
                        <option value="{{ equipmentType }}">{{ equipmentType }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Price Range Filter -->
            <div class="filter-group">
                <span class="filter-label">Price Range:</span>
                <div class="price-filter-group">
                    <input type="number" class="form-control form-control-sm price-input" id="minPrice" placeholder="Min ₱" step="0.01" min="0">
                    <span class="price-separator">-</span>
                    <input type="number" class="form-control form-control-sm price-input" id="maxPrice" placeholder="Max ₱" step="0.01" min="0">
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="equipmentTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Equipment Type</th>
                        <th>Equipment Name</th>
                        <th>Availability</th>
                        <th>Price</th>
                        <th>Active Bookings</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in equipmentWithData|default([]) %}
                        {% set equipment = item.entity %}
                        {% set bookingCount = item.bookingCount %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td data-type="{{ equipment.EquipmentType }}">{{ equipment.EquipmentType }}</td>
                            <td>{{ equipment.Equipment }}</td>
                            <td>
                                {% if equipment.Availability %}
                                    <span class="availability-badge availability-yes" data-search="Available">
                                        <span class="status-indicator status-available"></span>Available
                                    </span>
                                {% else %}
                                    <span class="availability-badge availability-no" data-search="Unavailable">
                                        <span class="status-indicator status-unavailable"></span>Unavailable
                                    </span>
                                {% endif %}
                            </td>
                            <td class="price-cell" data-price="{{ equipment.Price }}">₱{{ equipment.Price|number_format(2) }}</td>
                            <td>
                                <span class="booking-badge {% if bookingCount > 0 %}has-bookings{% else %}no-bookings{% endif %}"
                                      title="{% if bookingCount > 0 %}{{ bookingCount }} active booking(s){% else %}No active bookings{% endif %}">
                                    <i class="fas fa-calendar-check"></i>
                                    {{ bookingCount }}
                                </span>
                            </td>
                            <td class="actions-cell">
                                <div class="btn-group" role="group">
                                    <a href="{{ path('app_equipment_show', {'id': equipment.id}) }}" class="btn btn-show" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ path('app_equipment_edit', {'id': equipment.id}) }}" class="btn btn-edit" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form method="post" action="{{ path('app_equipment_delete', {'id': equipment.id}) }}" 
                                        onsubmit="return confirmDeleteEquipment({{ bookingCount }}, '{{ equipment.Equipment|escape('js') }}');" 
                                        class="delete-form d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ equipment.id) }}">
                                        <button type="submit" class="btn-icon" title="{% if bookingCount > 0 %}Cannot delete - has {{ bookingCount }} booking(s){% else %}Delete{% endif %}"
                                            {% if bookingCount > 0 %}disabled{% endif %}>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        {% for equipment in equipment|default([]) %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td data-type="{{ equipment.EquipmentType }}">{{ equipment.EquipmentType }}</td>
                                <td>{{ equipment.Equipment }}</td>
                                <td>
                                    {% if equipment.Availability %}
                                        <span class="availability-badge availability-yes" data-search="Available">
                                            <span class="status-indicator status-available"></span>Available
                                        </span>
                                    {% else %}
                                        <span class="availability-badge availability-no" data-search="Unavailable">
                                            <span class="status-indicator status-unavailable"></span>Unavailable
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="price-cell" data-price="{{ equipment.Price }}">₱{{ equipment.Price|number_format(2) }}</td>
                                <td>
                                    <span class="booking-badge no-bookings" title="No active bookings">
                                        <i class="fas fa-calendar-check"></i>
                                        0
                                    </span>
                                </td>
                                <td class="actions-cell">
                                    <div class="btn-group" role="group">
                                        <a href="{{ path('app_equipment_show', {'id': equipment.id}) }}" class="btn btn-show" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ path('app_equipment_edit', {'id': equipment.id}) }}" class="btn btn-edit" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="post" action="{{ path('app_equipment_delete', {'id': equipment.id}) }}" 
                                            onsubmit="return confirmDeleteEquipment(0, '{{ equipment.Equipment|escape('js') }}');" 
                                            class="delete-form d-inline">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ equipment.id) }}">
                                            <button type="submit" class="btn-icon" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-4">No equipment records found</td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables Core JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- DataTables Extensions -->
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    
    <!-- PDF export support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <script>
        $(document).ready(function() {
            // Auto-dismiss flash messages after 5 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
            
            // Confirm delete function
            window.confirmDeleteEquipment = function(bookingCount, equipmentName) {
                if (bookingCount > 0) {
                    alert(`Cannot delete "${equipmentName}" because it has ${bookingCount} active booking(s).\nPlease delete or reassign the bookings first.`);
                    return false;
                }
                return confirm(`Are you sure you want to delete "${equipmentName}"?`);
            };
            
            // Initialize DataTable with search bar positioned on right
            var table = $('#equipmentTable').DataTable({
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                    '<"row"<"col-sm-12"tr>>' +
                    '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="fas fa-copy"></i> Copy',
                        className: 'btn btn-outline-secondary',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-outline-success',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn btn-outline-danger',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        },
                        customize: function(doc) {
                            doc.content[1].table.widths = 
                                ['10%', '20%', '25%', '15%', '15%', '15%'];
                        }
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Print',
                        className: 'btn btn-outline-dark',
                        exportOptions: {
                            columns: ':not(:last-child)'
                        }
                    },
                    {
                        extend: 'colvis',
                        text: '<i class="fas fa-columns"></i> Columns',
                        className: 'btn btn-outline-info'
                    }
                ],
                language: {
                    search: "Search equipment:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ equipment",
                    infoEmpty: "Showing 0 to 0 of 0 equipment",
                    infoFiltered: "(filtered from _MAX_ total equipment)",
                    zeroRecords: "No matching equipment found",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                order: [[0, 'asc']],
                pageLength: 10,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                columnDefs: [
                    {
                        targets: 3, // Availability column
                        render: function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // For sorting, extract the availability from data-search attribute
                                var span = $('<div>').html(data).find('[data-search]');
                                if (span.length) {
                                    return span.data('search') === 'Available' ? 1 : 0;
                                }
                                return data.includes('Available') ? 1 : 0;
                            }
                            return data;
                        }
                    },
                    {
                        targets: 4, // Price column
                        render: function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                return parseFloat(data.replace('$', '').replace(',', ''));
                            }
                            return data;
                        }
                    },
                    {
                        targets: 5, // Booking count column
                        orderable: false,
                        searchable: false
                    },
                    {
                        targets: -1, // Actions column
                        orderable: false,
                        searchable: false
                    }
                ]
            });
            
            // Custom filter functions for availability
            function filterAvailable() {
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        // Check availability column (index 3)
                        var availabilityCell = table.cell(dataIndex, 3).node();
                        if (availabilityCell) {
                            var availabilityText = $(availabilityCell).find('[data-search]').data('search');
                            return availabilityText === 'Available';
                        }
                        return false;
                    }
                );
                table.draw();
                // Remove the filter function so we can apply new ones
                $.fn.dataTable.ext.search.pop();
            }
            
            function filterUnavailable() {
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        // Check availability column (index 3)
                        var availabilityCell = table.cell(dataIndex, 3).node();
                        if (availabilityCell) {
                            var availabilityText = $(availabilityCell).find('[data-search]').data('search');
                            return availabilityText === 'Unavailable';
                        }
                        return false;
                    }
                );
                table.draw();
                // Remove the filter function so we can apply new ones
                $.fn.dataTable.ext.search.pop();
            }
            
            function clearFilters() {
                table.search('').columns().search('').draw();
                $('#typeFilter').val('');
                $('#minPrice').val('');
                $('#maxPrice').val('');
            }
            
            // Availability filter buttons
            $('#filterAll').click(function() {
                clearFilters();
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterAvailable').click(function() {
                clearFilters();
                filterAvailable();
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            $('#filterUnavailable').click(function() {
                clearFilters();
                filterUnavailable();
                $('.btn-filter').removeClass('active');
                $(this).addClass('active');
            });
            
            // Set initial active filter
            $('#filterAll').addClass('active');
            
            // Style the DataTables buttons
            $('.dt-buttons .btn').removeClass('btn-secondary').addClass('me-2 mb-2');
            
            // Add custom search input styling
            $('.dataTables_filter input').addClass('form-control form-control-sm').attr('placeholder', 'Search equipment...');
            
            // Add custom length select styling
            $('.dataTables_length select').addClass('form-select form-select-sm');
            
            // Equipment type filter change event
            $('#typeFilter').on('change', function() {
                var val = $(this).val();
                if (val === '') {
                    table.column(1).search('').draw();
                } else {
                    // Exact match for equipment type
                    table.column(1).search('^' + val + '$', true, false).draw();
                }
            });
            
            // Filter by price range - FIXED VERSION
            function filterByPrice() {
                var minPrice = parseFloat($('#minPrice').val()) || 0;
                var maxPrice = parseFloat($('#maxPrice').val()) || Infinity;
                
                // Clear any existing price filters
                $.fn.dataTable.ext.search.pop();
                
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        // Get the row data
                        var row = table.row(dataIndex).data();
                        
                        // Extract price from the 5th column (index 4)
                        var priceCell = $(table.cell(dataIndex, 4).node());
                        var price = 0;
                        
                        // Method 1: Try to get from data-price attribute if available
                        if (priceCell.length && priceCell.data('price')) {
                            price = parseFloat(priceCell.data('price'));
                        } 
                        // Method 2: Extract from text content
                        else {
                            var priceText = table.cell(dataIndex, 4).data();
                            // Remove currency symbol and any commas
                            priceText = priceText.replace(/[^0-9.-]+/g, '');
                            price = parseFloat(priceText) || 0;
                        }
                        
                        // Debug logging (remove in production)
                        console.log('Checking price:', price, 'Min:', minPrice, 'Max:', maxPrice);
                        
                        return price >= minPrice && price <= maxPrice;
                    }
                );
                table.draw();
            }

            // Price input event listeners - UPDATED
            $('#minPrice, #maxPrice').on('keyup change', function() {
                // Add a small delay to handle rapid typing
                clearTimeout(window.priceFilterTimeout);
                window.priceFilterTimeout = setTimeout(function() {
                    filterByPrice();
                }, 300);
            });

            // Also update the clearFilters function to properly clear price filters
            function clearFilters() {
                // Clear all DataTable search filters
                table.search('').columns().search('').draw();
                
                // Clear custom search functions
                while($.fn.dataTable.ext.search.length > 0) {
                    $.fn.dataTable.ext.search.pop();
                }
                
                // Clear input values
                $('#typeFilter').val('');
                $('#minPrice').val('');
                $('#maxPrice').val('');
                
                // Redraw table without any filters
                table.draw();
            }
            
            // Dynamically populate equipment type filter if not passed from controller
            if ($('#typeFilter option').length <= 1) { // Only has "All Types"
                var equipmentTypes = [];
                table.column(1).data().each(function(value) {
                    if (value && equipmentTypes.indexOf(value) === -1) {
                        equipmentTypes.push(value);
                    }
                });
                
                if (equipmentTypes.length > 0) {
                    equipmentTypes.sort();
                    var typeFilter = $('#typeFilter');
                    typeFilter.empty().append('<option value="">All Types</option>');
                    
                    equipmentTypes.forEach(function(type) {
                        typeFilter.append('<option value="' + type + '">' + type + '</option>');
                    });
                }
            }
            
            // Auto-close alerts when clicked
            $(document).on('click', '.alert .btn-close', function() {
                $(this).closest('.alert').alert('close');
            });
        });
    </script>
{% endblock %}